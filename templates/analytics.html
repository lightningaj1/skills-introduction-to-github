{% extends "layout.html" %}

{% block title %}Analytics Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4">Geological Analytics Dashboard</h2>
    
    <div class="row">
        <!-- Mineral Statistics -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Deposits by Mineral Type</h5>
                </div>
                <div class="card-body">
                    <canvas id="mineralChart" height="80"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Status Distribution -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Deposit Status Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Accessibility Statistics -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Exploration Site Accessibility</h5>
                </div>
                <div class="card-body">
                    <canvas id="accessibilityChart" height="80"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Top Mineral Resources -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Estimated Reserves by Mineral</h5>
                </div>
                <div class="card-body">
                    <canvas id="reservesChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- State Minerals Table -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">South Sudan States - Geological Summary</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>State</th>
                                    <th>Primary Minerals</th>
                                    <th>Deposits</th>
                                    <th>Exploration Sites</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for state in state_minerals %}
                                <tr>
                                    <td><strong>{{ state.state }}</strong></td>
                                    <td>
                                        {% if state.minerals %}
                                            {% set mineral_list = state.minerals.split(',') %}
                                            {% for mineral in mineral_list[:3] %}
                                                <span class="badge badge-info">{{ mineral.strip() }}</span>
                                            {% endfor %}
                                            {% if mineral_list|length > 3 %}
                                                <span class="badge badge-secondary">+{{ mineral_list|length - 3 }} more</span>
                                            {% endif %}
                                        {% else %}
                                            <em>None</em>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge badge-success">{{ state.deposit_count }}</span>
                                    </td>
                                    <td>
                                        <a href="/map/sudan" class="text-primary">View Map</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Key Metrics -->
    <div class="row">
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Total Deposits</h6>
                    <h2>{{ mineral_stats|length }}</h2>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Mineral Types</h6>
                    <h2>{{ mineral_stats|length }}</h2>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Exploration Sites</h6>
                    <h2>{{ accessibility_stats|map(attribute='count')|sum }}</h2>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">South Sudan States</h6>
                    <h2>{{ state_minerals|length }}</h2>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
    // Chart colors
    const chartColors = {
        primary: '#0d6efd',
        success: '#198754',
        danger: '#dc3545',
        warning: '#ffc107',
        info: '#0dcaf0',
        dark: '#212529'
    };
    
    // Mineral Statistics Chart
    const mineralStats = {{ mineral_stats|tojson }};
    const mineralCtx = document.getElementById('mineralChart').getContext('2d');
    new Chart(mineralCtx, {
        type: 'bar',
        data: {
            labels: mineralStats.map(m => m.name),
            datasets: [{
                label: 'Number of Deposits',
                data: mineralStats.map(m => m.count),
                backgroundColor: [
                    chartColors.primary,
                    chartColors.success,
                    chartColors.danger,
                    chartColors.warning,
                    chartColors.info,
                    chartColors.dark
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
    
    // Status Distribution Chart
    const statusStats = {{ status_stats|tojson }};
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: statusStats.map(s => s.status),
            datasets: [{
                data: statusStats.map(s => s.count),
                backgroundColor: [
                    chartColors.success,    // active
                    chartColors.warning,    // prospect
                    chartColors.dark        // historical
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Accessibility Statistics
    const accessStats = {{ accessibility_stats|tojson }};
    const accessCtx = document.getElementById('accessibilityChart').getContext('2d');
    new Chart(accessCtx, {
        type: 'pie',
        data: {
            labels: accessStats.map(a => a.accessibility),
            datasets: [{
                data: accessStats.map(a => a.count),
                backgroundColor: [
                    chartColors.success,    // accessible
                    chartColors.warning,    // difficult
                    chartColors.danger      // impassable
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
    
    // Reserves Chart (top 10 by estimated reserves)
    const topReserves = mineralStats
        .filter(m => m.total_reserves && m.total_reserves > 0)
        .sort((a, b) => (b.total_reserves || 0) - (a.total_reserves || 0))
        .slice(0, 10);
    
    const reservesCtx = document.getElementById('reservesChart').getContext('2d');
    new Chart(reservesCtx, {
        type: 'horizontalBar',
        type: 'bar',
        data: {
            labels: topReserves.map(m => m.name),
            datasets: [{
                label: 'Estimated Reserves (tonnes)',
                data: topReserves.map(m => m.total_reserves || 0),
                backgroundColor: chartColors.primary
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: { beginAtZero: true }
            }
        }
    });
</script>
{% endblock %}
