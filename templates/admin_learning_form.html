{% extends "layout.html" %}

{% block title %}{% if lesson %}Edit Lesson{% else %}Add New Lesson{% endif %} - Admin{% endblock %}

{% block content %}
<!-- Header -->
<div class="bg-gradient py-4 mb-4">
    <div class="container">
        <h1 class="display-5 fw-bold text-white">
            {% if lesson %}
            <i class="fas fa-edit text-light me-3"></i>Edit Lesson
            {% else %}
            <i class="fas fa-plus text-light me-3"></i>Add New Lesson
            {% endif %}
        </h1>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-lg-8">
            <!-- Error Messages -->
            {% if errors %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <strong><i class="fas fa-exclamation-circle me-2"></i>Errors Found:</strong>
                <ul class="mb-0 mt-2">
                    {% for error in errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}

            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <form method="POST" class="needs-validation">
                        <!-- CSRF Token (Required for security) -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <!-- Title -->
                        <div class="mb-4">
                            <label for="title" class="form-label fw-bold">
                                <i class="fas fa-heading text-primary me-2"></i>Lesson Title
                            </label>
                            <input type="text" class="form-control form-control-lg" id="title" name="title" 
                                   value="{{ lesson.title if lesson else form_data.get('title', '') }}"
                                   placeholder="e.g., Introduction to Minerals" required>
                            <small class="text-muted">The main title of your lesson</small>
                        </div>

                        <!-- Category -->
                        <div class="mb-4">
                            <label for="category" class="form-label fw-bold">
                                <i class="fas fa-layer-group text-primary me-2"></i>Category
                            </label>
                            <input type="text" class="form-control form-control-lg" id="category" name="category" 
                                   list="categoryList"
                                   value="{{ lesson.category if lesson else form_data.get('category', '') }}"
                                   placeholder="e.g., Basics, Mineralogy, Mining" required>
                            <datalist id="categoryList">
                                <option value="Basics">Basics</option>
                                <option value="Mineralogy">Mineralogy</option>
                                <option value="Mining">Mining</option>
                                <option value="Economics">Economics</option>
                                <option value="Geology">Geology</option>
                                <option value="Technology">Technology</option>
                            </datalist>
                            <small class="text-muted">Organize your lesson by topic</small>
                        </div>

                        <!-- Summary -->
                        <div class="mb-4">
                            <label for="summary" class="form-label fw-bold">
                                <i class="fas fa-align-left text-primary me-2"></i>Summary
                            </label>
                            <textarea class="form-control" id="summary" name="summary" rows="3"
                                      placeholder="Brief summary of the lesson (2-3 sentences)"
                                      required>{{ lesson.summary if lesson else form_data.get('summary', '') }}</textarea>
                            <small class="text-muted">This appears in lesson cards and preview</small>
                        </div>

                        <!-- Main Content -->
                        <div class="mb-4">
                            <label for="content" class="form-label fw-bold">
                                <i class="fas fa-file-alt text-primary me-2"></i>Lesson Content
                            </label>
                            <textarea class="form-control" id="content" name="content" rows="12"
                                      placeholder="Write your lesson content here. You can use HTML for formatting."
                                      required>{{ lesson.content if lesson else form_data.get('content', '') }}</textarea>
                            <small class="text-muted d-block mt-2">
                                <strong>Formatting tips:</strong> You can use HTML tags like &lt;h2&gt;, &lt;p&gt;, &lt;ul&gt;, &lt;li&gt;, &lt;strong&gt;, etc.
                            </small>
                        </div>

                        <!-- Image URL -->
                        <div class="mb-4">
                            <label for="image" class="form-label fw-bold">
                                <i class="fas fa-image text-primary me-2"></i>Image URL
                            </label>
                            <input type="url" class="form-control" id="image" name="image" 
                                   value="{{ lesson.image if lesson else form_data.get('image', '/static/images/default_lesson.jpg') }}"
                                   placeholder="/static/images/lesson.jpg">
                            <small class="text-muted">URL to the lesson cover image</small>
                        </div>

                        <!-- Difficulty Level -->
                        <div class="mb-4">
                            <label for="difficulty_level" class="form-label fw-bold">
                                <i class="fas fa-graduation-cap text-primary me-2"></i>Difficulty Level
                            </label>
                            <select class="form-select form-select-lg" id="difficulty_level" name="difficulty_level" required>
                                <option value="beginner" {% if lesson and lesson.difficulty_level == 'beginner' %}selected{% endif %}>
                                    Beginner - Introductory concepts
                                </option>
                                <option value="intermediate" {% if lesson and lesson.difficulty_level == 'intermediate' %}selected{% endif %}>
                                    Intermediate - Moderate depth
                                </option>
                                <option value="advanced" {% if lesson and lesson.difficulty_level == 'advanced' %}selected{% endif %}>
                                    Advanced - In-depth technical content
                                </option>
                            </select>
                        </div>

                        <!-- Related Minerals -->
                        <div class="mb-4">
                            <label for="related_minerals" class="form-label fw-bold">
                                <i class="fas fa-gem text-primary me-2"></i>Related Minerals
                            </label>
                            <input type="text" class="form-control" id="related_minerals" name="related_minerals"
                                   value="{{ lesson.related_minerals if lesson else form_data.get('related_minerals', '') }}"
                                   placeholder="Enter mineral names separated by commas (e.g., Gold, Diamond, Gypsum)">
                            <div class="mt-2" id="mineral-suggestions" style="display: none;">
                                <small class="text-muted d-block mb-2">Available minerals:</small>
                                <div class="btn-group" role="group" style="flex-wrap: wrap;">
                                    {% for mineral in minerals %}
                                    <button type="button" class="btn btn-outline-secondary btn-sm mineral-btn" 
                                            data-mineral="{{ mineral.name }}">
                                        {{ mineral.name }}
                                    </button>
                                    {% endfor %}
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2">Link this lesson to specific minerals in the database</small>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                            <a href="/admin/learning" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>
                                {% if lesson %}Save Changes{% else %}Create Lesson{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar Help -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-4 sticky-top" style="top: 20px;">
                <div class="card-header bg-light border-bottom">
                    <h6 class="mb-0"><i class="fas fa-lightbulb text-warning me-2"></i>Tips</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong class="text-muted d-block mb-2">Good Title Examples:</strong>
                        <small class="d-block">• Introduction to Minerals</small>
                        <small class="d-block">• Crystal Systems in Geology</small>
                        <small class="d-block">• How Mining Works</small>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <strong class="text-muted d-block mb-2">Content Formatting:</strong>
                        <small class="d-block">&lt;h2&gt;Heading&lt;/h2&gt;</small>
                        <small class="d-block">&lt;p&gt;Paragraph&lt;/p&gt;</small>
                        <small class="d-block">&lt;strong&gt;Bold&lt;/strong&gt;</small>
                        <small class="d-block">&lt;em&gt;Italic&lt;/em&gt;</small>
                        <small class="d-block">&lt;ul&gt;&lt;li&gt;List item&lt;/li&gt;&lt;/ul&gt;</small>
                    </div>
                    <hr>
                    <div>
                        <strong class="text-muted d-block mb-2">Best Practices:</strong>
                        <small class="d-block">✓ Use clear, simple language</small>
                        <small class="d-block">✓ Include practical examples</small>
                        <small class="d-block">✓ Link to related minerals</small>
                        <small class="d-block">✓ Organize with headings</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('related_minerals').addEventListener('focus', function() {
        document.getElementById('mineral-suggestions').style.display = 'block';
    });

    document.querySelectorAll('.mineral-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const input = document.getElementById('related_minerals');
            const mineralName = this.getAttribute('data-mineral');
            const currentValue = input.value.trim();
            
            if (currentValue) {
                input.value = currentValue + ', ' + mineralName;
            } else {
                input.value = mineralName;
            }
        });
    });
</script>

{% endblock %}
